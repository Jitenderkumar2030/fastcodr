"use strict";const u=require("electron"),h=require("path"),U=require("child_process"),we=require("events"),F=require("fs"),Ee=require("http");var I=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},te={},D={exports:{}},K={};Object.defineProperty(K,"__esModule",{value:!0});const q=(r,s)=>`${r.id}-${s}`;class ye{constructor(){this.nextId=0,this.storage={},this.owners={},this.electronIds=new WeakMap}add(s,t,o){const a=this.saveToStorage(o),p=q(s,t);let f=this.owners[p];return f||(f=this.owners[p]=new Map,this.registerDeleteListener(s,t)),f.has(a)||(f.set(a,0),this.storage[a].count++),f.set(a,f.get(a)+1),a}get(s){const t=this.storage[s];if(t!=null)return t.object}remove(s,t,o){const a=q(s,t),p=this.owners[a];if(p&&p.has(o)){const f=p.get(o)-1;f<=0?(p.delete(o),this.dereference(o)):p.set(o,f)}}clear(s,t){const o=q(s,t),a=this.owners[o];if(a){for(const p of a.keys())this.dereference(p);delete this.owners[o]}}saveToStorage(s){let t=this.electronIds.get(s);return t||(t=++this.nextId,this.storage[t]={count:0,object:s},this.electronIds.set(s,t)),t}dereference(s){const t=this.storage[s];t!=null&&(t.count-=1,t.count===0&&(this.electronIds.delete(t.object),delete this.storage[s]))}registerDeleteListener(s,t){const o=t.split("-")[0],a=(p,f)=>{f&&f.toString()===o&&(s.removeListener("render-view-deleted",a),this.clear(s,t))};s.on("render-view-deleted",a)}}K.default=new ye;var P={};Object.defineProperty(P,"__esModule",{value:!0});P.deserialize=P.serialize=P.isSerializableObject=P.isPromise=void 0;const _e=u;function be(r){return r&&r.then&&r.then instanceof Function&&r.constructor&&r.constructor.reject&&r.constructor.reject instanceof Function&&r.constructor.resolve&&r.constructor.resolve instanceof Function}P.isPromise=be;const Re=[Boolean,Number,String,Date,Error,RegExp,ArrayBuffer];function Y(r){return r===null||ArrayBuffer.isView(r)||Re.some(s=>r instanceof s)}P.isSerializableObject=Y;const re=function(r,s){const o=Object.entries(r).map(([a,p])=>[a,s(p)]);return Object.fromEntries(o)};function Pe(r){const s=[],t=r.getScaleFactors();if(t.length===1){const o=t[0],a=r.getSize(o),p=r.toBitmap({scaleFactor:o});s.push({scaleFactor:o,size:a,buffer:p})}else for(const o of t){const a=r.getSize(o),p=r.toDataURL({scaleFactor:o});s.push({scaleFactor:o,size:a,dataURL:p})}return{__ELECTRON_SERIALIZED_NativeImage__:!0,representations:s}}function je(r){const s=_e.nativeImage.createEmpty();if(r.representations.length===1){const{buffer:t,size:o,scaleFactor:a}=r.representations[0],{width:p,height:f}=o;s.addRepresentation({buffer:t,scaleFactor:a,width:p,height:f})}else for(const t of r.representations){const{dataURL:o,size:a,scaleFactor:p}=t,{width:f,height:m}=a;s.addRepresentation({dataURL:o,scaleFactor:p,width:f,height:m})}return s}function x(r){return r&&r.constructor&&r.constructor.name==="NativeImage"?Pe(r):Array.isArray(r)?r.map(x):Y(r)?r:r instanceof Object?re(r,x):r}P.serialize=x;function H(r){return r&&r.__ELECTRON_SERIALIZED_NativeImage__?je(r):Array.isArray(r)?r.map(H):Y(r)?r:r instanceof Object?re(r,H):r}P.deserialize=H;var W={};Object.defineProperty(W,"__esModule",{value:!0});W.getElectronBinding=void 0;const Oe=r=>process._linkedBinding?process._linkedBinding("electron_common_"+r):process.electronBinding?process.electronBinding(r):null;W.getElectronBinding=Oe;D.exports;(function(r,s){var t=I&&I.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(s,"__esModule",{value:!0}),s.initialize=s.isInitialized=s.enable=s.isRemoteModuleEnabled=void 0;const o=we,a=t(K),p=P,f=u,m=W,{Promise:w}=I,_=m.getElectronBinding("v8_util"),j=(()=>{var e,c;const n=Number((c=(e=process.versions.electron)===null||e===void 0?void 0:e.split("."))===null||c===void 0?void 0:c[0]);return Number.isNaN(n)||n<14})(),O=["length","name","arguments","caller","prototype"],B=new Map,ce=new FinalizationRegistry(e=>{const c=e.id[0]+"~"+e.id[1],n=B.get(c);if(n!==void 0&&n.deref()===void 0&&(B.delete(c),!e.webContents.isDestroyed()))try{e.webContents.sendToFrame(e.frameId,"REMOTE_RENDERER_RELEASE_CALLBACK",e.id[0],e.id[1])}catch(l){console.warn(`sendToFrame() failed: ${l}`)}});function X(e){const c=e[0]+"~"+e[1],n=B.get(c);if(n!==void 0){const l=n.deref();if(l!==void 0)return l}}function ae(e,c,n,l){const i=new WeakRef(l),d=e[0]+"~"+e[1];return B.set(d,i),ce.register(l,{id:e,webContents:c,frameId:n}),l}const Z=new WeakMap,J=function(e){let c=Object.getOwnPropertyNames(e);return typeof e=="function"&&(c=c.filter(n=>!O.includes(n))),c.map(n=>{const l=Object.getOwnPropertyDescriptor(e,n);let i,d=!1;return l.get===void 0&&typeof e[n]=="function"?i="method":((l.set||l.writable)&&(d=!0),i="get"),{name:n,enumerable:l.enumerable,writable:d,type:i}})},Q=function(e){const c=Object.getPrototypeOf(e);return c===null||c===Object.prototype?null:{members:J(c),proto:Q(c)}},y=function(e,c,n,l=!1){let i;switch(typeof n){case"object":n instanceof Buffer?i="buffer":n&&n.constructor&&n.constructor.name==="NativeImage"?i="nativeimage":Array.isArray(n)?i="array":n instanceof Error?i="error":p.isSerializableObject(n)?i="value":p.isPromise(n)?i="promise":Object.prototype.hasOwnProperty.call(n,"callee")&&n.length!=null?i="array":l&&_.getHiddenValue(n,"simple")?i="value":i="object";break;case"function":i="function";break;default:i="value";break}return i==="array"?{type:i,members:n.map(d=>y(e,c,d,l))}:i==="nativeimage"?{type:i,value:p.serialize(n)}:i==="object"||i==="function"?{type:i,name:n.constructor?n.constructor.name:"",id:a.default.add(e,c,n),members:J(n),proto:Q(n)}:i==="buffer"?{type:i,value:n}:i==="promise"?(n.then(function(){},function(){}),{type:i,then:y(e,c,function(d,E){n.then(d,E)})}):i==="error"?{type:i,value:n,members:Object.keys(n).map(d=>({name:d,value:y(e,c,n[d])}))}:{type:"value",value:n}},k=function(e){const c=new Error(e);throw c.code="EBADRPC",c.errno=-72,c},ee=(e,c)=>{let l=`Attempting to call a function in a renderer window that has been closed or released.
Function provided here: ${Z.get(c)}`;if(e instanceof o.EventEmitter){const i=e.eventNames().filter(d=>e.listeners(d).includes(c));i.length>0&&(l+=`
Remote event names: ${i.join(", ")}`,i.forEach(d=>{e.removeListener(d,c)}))}console.warn(l)},le=(e,c)=>new Proxy(Object,{get(n,l,i){return l==="name"?c:Reflect.get(n,l,i)}}),v=function(e,c,n,l){const i=function(d){switch(d.type){case"nativeimage":return p.deserialize(d.value);case"value":return d.value;case"remote-object":return a.default.get(d.id);case"array":return v(e,c,n,d.value);case"buffer":return Buffer.from(d.value.buffer,d.value.byteOffset,d.value.byteLength);case"promise":return w.resolve({then:i(d.then)});case"object":{const E=d.name!=="Object"?Object.create({constructor:le(Object,d.name)}):{};for(const{name:M,value:T}of d.members)E[M]=i(T);return E}case"function-with-return-value":{const E=i(d.value);return function(){return E}}case"function":{const E=[n,d.id],M=X(E);if(M!==void 0)return M;const T=function(...he){let ne=!1;if(!e.isDestroyed())try{ne=e.sendToFrame(c,"REMOTE_RENDERER_CALLBACK",n,d.id,y(e,n,he))!==!1}catch(ge){console.warn(`sendToFrame() failed: ${ge}`)}ne||ee(this,T)};return Z.set(T,d.location),Object.defineProperty(T,"length",{value:d.length}),ae(E,e,c,T),T}default:throw new TypeError(`Unknown type: ${d.type}`)}};return l.map(i)},de=function(e){const c=e.getLastWebPreferences()||{};return c.enableRemoteModule!=null?!!c.enableRemoteModule:!1},L=new WeakMap,ue=function(e){return j&&!L.has(e)&&L.set(e,de(e)),L.get(e)};s.isRemoteModuleEnabled=ue;function pe(e){L.set(e,!0)}s.enable=pe;const b=function(e,c){f.ipcMain.on(e,(n,l,...i)=>{let d;if(!s.isRemoteModuleEnabled(n.sender)){n.returnValue={type:"exception",value:y(n.sender,l,new Error('@electron/remote is disabled for this WebContents. Call require("@electron/remote/main").enable(webContents) to enable it.'))};return}try{d=c(n,l,...i)}catch(E){d={type:"exception",value:y(n.sender,l,E)}}d!==void 0&&(n.returnValue=d)})},V=function(e,c,...n){const l={sender:e,returnValue:void 0,defaultPrevented:!1};return f.app.emit(c,l,e,...n),e.emit(c,l,...n),l},z=function(e,c,n){n&&console.warn(`WebContents (${e.id}): ${c}`,n)};let N=!1;function fe(){return N}s.isInitialized=fe;function me(){if(N)throw new Error("@electron/remote has already been initialized");N=!0,b("REMOTE_BROWSER_WRONG_CONTEXT_ERROR",function(e,c,n,l){const d=X([n,l]);d!==void 0&&ee(e.sender,d)}),b("REMOTE_BROWSER_REQUIRE",function(e,c,n,l){z(e.sender,`remote.require('${n}')`,l);const i=V(e.sender,"remote-require",n);if(i.returnValue===void 0){if(i.defaultPrevented)throw new Error(`Blocked remote.require('${n}')`);if(process.mainModule)i.returnValue=process.mainModule.require(n);else{let d=r;for(;d.parent;)d=d.parent;i.returnValue=d.require(n)}}return y(e.sender,c,i.returnValue)}),b("REMOTE_BROWSER_GET_BUILTIN",function(e,c,n,l){z(e.sender,`remote.getBuiltin('${n}')`,l);const i=V(e.sender,"remote-get-builtin",n);if(i.returnValue===void 0){if(i.defaultPrevented)throw new Error(`Blocked remote.getBuiltin('${n}')`);i.returnValue=u[n]}return y(e.sender,c,i.returnValue)}),b("REMOTE_BROWSER_GET_GLOBAL",function(e,c,n,l){z(e.sender,`remote.getGlobal('${n}')`,l);const i=V(e.sender,"remote-get-global",n);if(i.returnValue===void 0){if(i.defaultPrevented)throw new Error(`Blocked remote.getGlobal('${n}')`);i.returnValue=I[n]}return y(e.sender,c,i.returnValue)}),b("REMOTE_BROWSER_GET_CURRENT_WINDOW",function(e,c,n){z(e.sender,"remote.getCurrentWindow()",n);const l=V(e.sender,"remote-get-current-window");if(l.returnValue===void 0){if(l.defaultPrevented)throw new Error("Blocked remote.getCurrentWindow()");l.returnValue=e.sender.getOwnerBrowserWindow()}return y(e.sender,c,l.returnValue)}),b("REMOTE_BROWSER_GET_CURRENT_WEB_CONTENTS",function(e,c,n){z(e.sender,"remote.getCurrentWebContents()",n);const l=V(e.sender,"remote-get-current-web-contents");if(l.returnValue===void 0){if(l.defaultPrevented)throw new Error("Blocked remote.getCurrentWebContents()");l.returnValue=e.sender}return y(e.sender,c,l.returnValue)}),b("REMOTE_BROWSER_CONSTRUCTOR",function(e,c,n,l){l=v(e.sender,e.frameId,c,l);const i=a.default.get(n);return i==null&&k(`Cannot call constructor on missing remote object ${n}`),y(e.sender,c,new i(...l))}),b("REMOTE_BROWSER_FUNCTION_CALL",function(e,c,n,l){l=v(e.sender,e.frameId,c,l);const i=a.default.get(n);i==null&&k(`Cannot call function on missing remote object ${n}`);try{return y(e.sender,c,i(...l),!0)}catch(d){const E=new Error(`Could not call remote function '${i.name||"anonymous"}'. Check that the function signature is correct. Underlying error: ${d}
`+(d instanceof Error?`Underlying stack: ${d.stack}
`:""));throw E.cause=d,E}}),b("REMOTE_BROWSER_MEMBER_CONSTRUCTOR",function(e,c,n,l,i){i=v(e.sender,e.frameId,c,i);const d=a.default.get(n);return d==null&&k(`Cannot call constructor '${l}' on missing remote object ${n}`),y(e.sender,c,new d[l](...i))}),b("REMOTE_BROWSER_MEMBER_CALL",function(e,c,n,l,i){i=v(e.sender,e.frameId,c,i);const d=a.default.get(n);d==null&&k(`Cannot call method '${l}' on missing remote object ${n}`);try{return y(e.sender,c,d[l](...i),!0)}catch(E){const M=new Error(`Could not call remote method '${l}'. Check that the method signature is correct. Underlying error: ${E}`+(E instanceof Error?`Underlying stack: ${E.stack}
`:""));throw M.cause=E,M}}),b("REMOTE_BROWSER_MEMBER_SET",function(e,c,n,l,i){i=v(e.sender,e.frameId,c,i);const d=a.default.get(n);return d==null&&k(`Cannot set property '${l}' on missing remote object ${n}`),d[l]=i[0],null}),b("REMOTE_BROWSER_MEMBER_GET",function(e,c,n,l){const i=a.default.get(n);return i==null&&k(`Cannot get property '${l}' on missing remote object ${n}`),y(e.sender,c,i[l])}),b("REMOTE_BROWSER_DEREFERENCE",function(e,c,n){a.default.remove(e.sender,c,n)}),b("REMOTE_BROWSER_CONTEXT_RELEASE",(e,c)=>(a.default.clear(e.sender,c),null))}s.initialize=me})(D,D.exports);var Me=D.exports;(function(r){Object.defineProperty(r,"__esModule",{value:!0}),r.enable=r.isInitialized=r.initialize=void 0;var s=Me;Object.defineProperty(r,"initialize",{enumerable:!0,get:function(){return s.initialize}}),Object.defineProperty(r,"isInitialized",{enumerable:!0,get:function(){return s.isInitialized}}),Object.defineProperty(r,"enable",{enumerable:!0,get:function(){return s.enable}})})(te);var oe=te;const Te=`
<!DOCTYPE html>
<html>
<head></head>
    <meta charset="UTF-8">
    <title>登录成功</title>
    <script src="https://unpkg.com/react@17/umd/react.development.js"><\/script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"><\/script>
    <script src="https://unpkg.com/babel-standalone@6.26.0/babel.min.js"><\/script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #000000;
            color: #ffffff;
            font-family: -apple-system, BlinkMacSystemFont, 'Inter', sans-serif;
        }

        .success-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background: linear-gradient(180deg, #000000 0%, #111111 100%);
            padding: 24px;
        }

        .success-icon-container {
            width: 48px;
            height: 48px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 24px;
            animation: fadeIn 0.6s ease-out, scaleIn 0.6s ease-out;
        }

        .success-icon {
            color: #10B981;
            font-size: 24px;
        }

        .success-message {
            color: #ffffff;
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 12px;
            opacity: 0;
            animation: fadeIn 0.6s ease-out 0.2s forwards;
        }

        .success-description {
            color: rgba(255, 255, 255, 0.6);
            font-size: 14px;
            text-align: center;
            opacity: 0;
            animation: fadeIn 0.6s ease-out 0.4s forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes scaleIn {
            from {
                transform: scale(0.8);
            }
            to {
                transform: scale(1);
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        function LoginSuccess() {
            return (
                <div className="success-container">
                    <div className="success-icon-container">
                        <div className="success-icon">✓</div>
                    </div>
                    <h1 className="success-message">登录成功</h1>
                    <p className="success-description">请返回应用程序继续操作</p>
                </div>
            );
        }

        ReactDOM.render(<LoginSuccess />, document.getElementById('root'));
    <\/script>
</body>
</html>
`;function Se(r){const s=Ee.createServer((t,o)=>{var a;if((a=t.url)!=null&&a.startsWith("/auth/callback")){const f=new URL(t.url,"http://127.0.0.1:12900").searchParams.get("token");f&&r&&(console.log("准备发送 token 到渲染进程:",f),r.webContents.send("login:callback",f)),o.writeHead(200,{"Content-Type":"text/html"}),o.end(Te)}else o.writeHead(404),o.end("Not Found")});return s.listen(12900,()=>{console.log("登录服务器启动在端口 12900")}),s}const $e=["node_modules","dist",".swc",".next","package-lock.json","pnpm-lock.yaml"];console.log({appPath:u.app.getAppPath(),exe:u.app.getPath("exe"),home:u.app.getPath("home"),appData:u.app.getPath("appData"),userData:u.app.getPath("userData"),temp:u.app.getPath("temp"),downloads:u.app.getPath("downloads"),desktop:u.app.getPath("desktop"),documents:u.app.getPath("documents")});const G=h.join(u.app.getAppPath(),"../../logs"),se=h.join(G,`app-${new Date().toISOString().split("T")[0]}.log`);try{F.existsSync(G)||F.mkdirSync(G,{recursive:!0})}catch(r){console.error("Failed to create log directory:",r)}function g(r){const t=`${new Date().toISOString()} - ${r}
`;try{F.appendFileSync(se,t),console.log(t)}catch(o){console.error("Failed to write log:",o)}}g("sadasd");g(JSON.stringify(process.env,null,2));g("Application starting...");g(`Log file location: ${se}`);g(`Process arguments: ${process.argv.join(" ")}`);g(`Electron version: ${process.versions.electron}`);g(`Chrome version: ${process.versions.chrome}`);g(`Node version: ${process.versions.node}`);g(u.app.getAppPath());g(__dirname);g(u.app.getPath("exe"));process.on("uncaughtException",r=>{g(`Uncaught Exception: ${r.stack||r.message}`)});process.on("unhandledRejection",r=>{g(`Unhandled Rejection: ${r}`)});u.app.on("will-finish-launching",()=>{g("App will finish launching")});let A;try{const r=h.join(__dirname,"../../../node_modules/node-pty");A=require(r),console.log("Successfully loaded node-pty from:",h.join(__dirname,"../../../node_modules/node-pty"))}catch{try{const s=h.join(__dirname,"./node_modules/node-pty");A=require(s),console.log("Successfully loaded node-pty from:",h.join(__dirname,"./node_modules/node-pty"))}catch{try{const t=h.join(u.app.getAppPath(),"../../app.asar.unpacked/node_modules/node-pty");A=require(t),console.log("Successfully loaded node-pty from:",h.join(u.app.getAppPath(),"../../app.asar.unpacked/node_modules/node-pty"))}catch{try{A=require("node-pty"),console.log("Successfully loaded node-pty from:","node-pty")}catch(o){console.error("Failed to load node-pty directly:",o),A={spawn:()=>{throw new Error("node-pty not available")}}}}}}let S="";const C=new Map,$=new Map;oe.initialize();let R=null;function ie(){g("Starting to create window");try{R=new u.BrowserWindow({width:1200,height:800,webPreferences:{nodeIntegration:!0,contextIsolation:!0,preload:process.env.VITE_DEV_SERVER_URL?h.join(__dirname,"preload.js"):h.join(u.app.getAppPath(),"dist-electron","preload.js")}});const r=Se(R);if(u.ipcMain.on("open:external:url",(s,t)=>{const{shell:o}=require("electron");o.openExternal(t)}),R.on("closed",()=>{R=null,r&&r.close()}),u.nativeTheme.themeSource="dark",R.webContents.on("did-fail-load",(s,t,o)=>{g(`Window failed to load: ${o} (${t})`)}),R.on("unresponsive",()=>{g("Window became unresponsive")}),R.on("responsive",()=>{g("Window became responsive")}),process.env.VITE_DEV_SERVER_URL)g(`Loading dev server URL: ${process.env.VITE_DEV_SERVER_URL}`),R.loadURL(process.env.VITE_DEV_SERVER_URL),R.webContents.openDevTools();else{const s=h.join(__dirname,"../dist/index.html");g(`Loading production HTML file: ${s}`),R.loadFile(s)}oe.enable(R.webContents),u.ipcMain.handle("node-container:check-file-exists",async(s,t)=>{try{return await require("fs/promises").access(t),!0}catch{throw new Error("文件不存在")}}),u.ipcMain.handle("node-container:init",async()=>!0),u.ipcMain.handle("node-container:mkdir",async(s,t,o)=>(await require("fs/promises").mkdir(t,o),!0)),u.ipcMain.handle("node-container:writeFile",async(s,t,o)=>(await require("fs/promises").writeFile(t,o),!0)),u.ipcMain.handle("node-container:readFile",async(s,t,o)=>await require("fs/promises").readFile(t,{encoding:o})),u.ipcMain.handle("node-container:readdir",async(s,t,o)=>await require("fs/promises").readdir(t,o)),u.ipcMain.handle("node-container:platform",async()=>require("os").platform()),u.ipcMain.handle("node-container:set-now-path",(s,t)=>{S=t}),u.ipcMain.handle("node-container:get-project-root",()=>S||(process.env.VITE_DEV_SERVER_URL?h.join(process.cwd(),"workspace"):h.join(u.app.getAppPath(),"../../workspace"))),u.ipcMain.handle("node-container:spawn",async(s,t,o,a)=>{try{console.log("Main Process: Spawning command:",t,o,a);const p=U.spawn(t,o,{cwd:process.env.VITE_DEV_SERVER_URL?h.join(process.cwd(),"workspace"):h.join(u.app.getAppPath(),"../../workspace"),env:{...process.env,PATH:`${process.env.PATH}${h.delimiter}${h.join(u.app.getAppPath(),"node_modules",".bin")}`,NODE_PATH:h.join(u.app.getAppPath(),"node_modules")},shell:!0,stdio:["pipe","pipe","pipe"]}),f=Math.random().toString(36).substr(2,9);console.log("Main Process: Process ID:",f),C.set(f,p);const m=s.sender;return p.stdout.on("data",w=>{const _=w.toString();console.log("Main Process: stdout:",_),m.send(`process-output-${f}`,_)}),p.stderr.on("data",w=>{const _=w.toString();console.error("Main Process: stderr:",_),m.send(`process-output-${f}`,_)}),p.on("error",w=>{console.error("Main Process: Process error:",w),m.send(`process-output-${f}`,`Error: ${w.message}
`)}),p.on("close",w=>{C.delete(f),m.send(`process-exit-${f}`,w||0)}),{processId:f}}catch(p){throw console.error("Main Process: Spawn error:",p),p}}),u.ipcMain.handle("node-container:wait-exit",async(s,t)=>{const o=C.get(t);if(!o)throw new Error("Process not found");return new Promise(a=>{o.on("close",p=>{C.delete(t),a(p)})})}),u.ipcMain.handle("node-container:kill-process",async(s,t)=>{const o=C.get(t);o&&(o.kill(),C.delete(t))}),u.ipcMain.handle("node-container:stop-server",async(s,t)=>{process.platform==="win32"?U.spawn("taskkill",["/F","/PID",t.toString()]):U.spawn("kill",["-9",t.toString()])}),u.ipcMain.handle("node-container:stat",async(s,t)=>{const a=await require("fs/promises").stat(t);return{isDirectory:a.isDirectory(),isFile:a.isFile(),size:a.size,mtime:a.mtime}}),u.ipcMain.handle("node-container:sync-filesystem",async(s,t)=>{try{const o=S||(process.env.VITE_DEV_SERVER_URL?h.join(process.cwd(),"workspace"):h.join(u.app.getAppPath(),"../../workspace")),a=require("fs/promises");await a.mkdir(o,{recursive:!0});async function p(m){const w=await a.readdir(m,{withFileTypes:!0}),_=[];for(const j of w){const O=h.join(m,j.name);["node_modules","dist",".swc",".next",".yaml"].includes(j.name)||(j.isDirectory()?_.push(...await p(O)):_.push(O))}return _}const f=await p(o);for(const[m,w]of Object.entries(t)){if(typeof w!="string"){console.log("Skipping non-string content:",m);continue}if(m.startsWith("node_modules/")){console.log("Skipping node_modules file:",m);continue}const _=h.join(o,m),j=h.dirname(_);await a.mkdir(j,{recursive:!0}),await a.writeFile(_,w,"utf-8");const O=f.indexOf(_);O>-1&&f.splice(O,1)}for(const m of f)$e.some(w=>(m==null?void 0:m.indexOf(w))>-1)||await a.unlink(m);return!0}catch(o){throw o}}),u.ipcMain.handle("terminal:create",(s,t)=>{console.log("terminal:create",t);let o=process.platform==="win32"?"powershell.exe":"bash";if(process.platform==="darwin")try{const m=process.env.SHELL;(m&&m.includes("zsh")||F.existsSync("/bin/zsh"))&&(o="zsh")}catch(m){console.error("Error detecting shell:",m)}const a=Math.random().toString(36).substr(2,9),p={...process.env,PATH:process.env.PATH||""};if(process.platform==="darwin"){const m=["/usr/local/bin","/opt/homebrew/bin","/usr/bin","/bin","/usr/sbin","/sbin",`${process.env.HOME}/.npm-global/bin`,`${process.env.HOME}/.nvm/versions/node/*/bin`];p.PATH=`${m.join(":")}:${p.PATH}`}const f=A.spawn(o,[],{name:"xterm-color",cols:t.cols||80,rows:t.rows||24,cwd:S||(process.env.VITE_DEV_SERVER_URL?h.join(process.cwd(),"workspace"):h.join(u.app.getAppPath(),"../../workspace")),env:p});return $.set(a,f),f.onData(m=>{R.webContents.send(`terminal-output-${a}`,m)}),{processId:a}}),u.ipcMain.handle("terminal:write",(s,t,o)=>{const a=$.get(t);a&&a.write(o)}),u.ipcMain.handle("terminal:resize",(s,t,o,a)=>{const p=$.get(t);p&&p.resize(o,a)}),u.ipcMain.handle("node-container:get-parent-paths",async(s,t)=>{try{const o=h.dirname(t),a=h.dirname(o),p=h.dirname(a);return{parentPath:o,grandParentPath:a,lastGrandParentPath:p}}catch(o){throw new Error(`获取上级目录失败: ${o.message}`)}}),u.ipcMain.handle("node-container:exec-command",async(s,t)=>{try{const{exec:o}=require("child_process");return new Promise((a,p)=>{o(t,(f,m,w)=>{if(f){p(f.message);return}if(w){p(w);return}a(m)})})}catch(o){throw new Error(`命令执行失败: ${o.message}`)}}),u.ipcMain.handle("terminal:dispose",(s,t)=>{const o=$.get(t);o&&(o.kill(),$.delete(t))}),R.on("closed",()=>{for(const s of Array.from($.values()))s.kill();$.clear()}),g(`App path: ${u.app.getAppPath()}`),g(`__dirname: ${__dirname}`),g(`Preload path: ${process.env.VITE_DEV_SERVER_URL?h.join(__dirname,"preload.js"):h.join(u.app.getAppPath(),"dist-electron","preload.js")}`)}catch(r){throw g(`Error creating window: ${r}`),r}}u.app.whenReady().then(()=>{g("App is ready");try{ie()}catch(r){g(`Error in whenReady handler: ${r}`)}}).catch(r=>{g(`Failed to initialize app: ${r}`)});u.app.on("window-all-closed",()=>{g("All windows closed"),process.platform!=="darwin"&&u.app.quit()});u.app.on("activate",()=>{g("App activated"),u.BrowserWindow.getAllWindows().length===0&&ie()});u.app.on("quit",()=>{g("App is quitting")});
